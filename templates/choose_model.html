<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NexusBot - Create a Bot From Your Data</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />

    <!-- SheetJS for reading Excel/CSV files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #0a0a0a;
            color: #e5e7eb;
        }

        .glass-nav {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hero-gradient-text {
            background: linear-gradient(to right, #38bdf8, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-drop-zone {
            border: 2px dashed #4b5563;
            transition: all 0.3s ease;
        }

        .file-drop-zone.dragover {
            border-color: #38bdf8;
            background-color: rgba(56, 189, 248, 0.1);
            transform: scale(1.02);
        }

        .chat-bubble.user {
            background-color: #38bdf8;
            color: white;
        }

        .chat-bubble.bot {
            background-color: #374151;
            color: #e5e7eb;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #38bdf8;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="antialiased">
    <!-- Header -->
    <header id="header" class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="w-full mx-auto px-6 lg:px-12 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">
                <a href="{{ url_for('home') }}">Nexus<span class="text-sky-400">Bot</span></a>
            </h1>
            <nav>
                <a href="#" onclick="resetApp()"
                    class="bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors duration-300">Restart</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-12">
        <!-- Upload Section -->
        <section id="upload-section" class="min-h-[calc(100vh-10rem)] flex items-center bg-grid">
            <div class="w-full mx-auto px-6 lg:px-12">
                <div class="text-center mb-12">
                    <h2 class="text-4xl md:text-5xl font-extrabold hero-gradient-text mb-4">
                        Create a Chatbot From Your Data
                    </h2>
                    <p class="text-lg text-gray-400 max-w-3xl mx-auto">
                        Upload any Excel or CSV file â€” and NexusBot will analyze and chat with it.
                    </p>
                </div>

                <div
                    class="max-w-3xl mx-auto bg-gray-800/50 backdrop-blur-sm p-8 rounded-xl border border-gray-700 shadow-lg">
                    <input type="file" id="file-input" class="hidden" accept=".csv, .xls, .xlsx" />
                    <label for="file-input" id="file-drop-zone"
                        class="file-drop-zone rounded-lg p-10 text-center cursor-pointer block hover:border-sky-400">
                        <div id="upload-prompt">
                            <svg class="w-12 h-12 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h4l2 2h4a2 2 0 012 2v2M9 19v-6l-2 2m4 4v-6l2 2" />
                            </svg>
                            <p class="text-gray-300 font-semibold">
                                Drag & drop your file here or click to browse
                            </p>
                            <p class="text-xs text-gray-500 mt-2">
                                Supported formats: .xlsx, .xls, .csv
                            </p>
                        </div>
                        <div id="file-feedback" class="hidden"></div>
                    </label>

                    <div id="error-message" class="text-red-400 mt-4 text-center"></div>

                    <div class="mt-8 text-center">
                        <button id="build-bot-btn"
                            class="w-full md:w-auto bg-sky-500 text-white font-bold py-3 px-12 rounded-lg hover:bg-sky-600 transition-colors duration-300 text-lg disabled:bg-gray-600 disabled:cursor-not-allowed"
                            disabled>
                            <span id="btn-text">Build Bot From Data</span>
                            <span id="btn-loader" class="hidden loader"></span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chatbot-section" class="hidden">
            <div class="max-w-4xl mx-auto px-4">
                <div
                    class="bg-gray-800/80 backdrop-blur-sm border border-gray-700 rounded-xl shadow-2xl flex flex-col h-[calc(100vh-8rem)]">
                    <div class="p-4 border-b border-gray-700">
                        <h2 class="text-xl font-bold text-center text-white">
                            Chat with <span id="bot-name" class="hero-gradient-text">Your Data</span>
                        </h2>
                    </div>

                    <div id="chat-window" class="flex-1 p-6 space-y-4 overflow-y-auto"></div>

                    <div id="thinking-indicator" class="px-6 pb-2 hidden">
                        <div class="flex items-center space-x-2">
                            <div class="chat-bubble bot rounded-full p-3">
                                <div class="flex items-center space-x-1">
                                    <span class="h-2 w-2 bg-gray-400 rounded-full animate-bounce"></span>
                                    <span
                                        class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                                    <span
                                        class="h-2 w-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-700">
                        <form id="chat-form" class="flex items-center space-x-4">
                            <input type="text" id="chat-input" placeholder="Ask a question about your data..."
                                class="w-full p-3 rounded-lg bg-gray-900 border border-gray-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none"
                                autocomplete="off" />
                            <button type="submit"
                                class="bg-sky-500 text-white font-bold p-3 rounded-lg hover:bg-sky-600">
                                âž¤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const uploadSection = document.getElementById("upload-section");
        const chatbotSection = document.getElementById("chatbot-section");
        const dropZone = document.getElementById("file-drop-zone");
        const fileInput = document.getElementById("file-input");
        const uploadPrompt = document.getElementById("upload-prompt");
        const fileFeedback = document.getElementById("file-feedback");
        const buildBotBtn = document.getElementById("build-bot-btn");
        const btnText = document.getElementById("btn-text");
        const btnLoader = document.getElementById("btn-loader");
        const errorMessage = document.getElementById("error-message");
        const chatWindow = document.getElementById("chat-window");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const botName = document.getElementById("bot-name");
        const thinkingIndicator = document.getElementById("thinking-indicator");

        let uploadedFile = null;
        let jsonData = null;

        // --- Handle file selection ---
        const handleFileSelection = (files) => {
            if (files.length === 0) return;
            const file = files[0];

            const allowed =
                file.name.endsWith(".csv") ||
                file.name.endsWith(".xls") ||
                file.name.endsWith(".xlsx");

            if (!allowed) {
                displayError("Invalid file type. Upload an Excel or CSV file.");
                return;
            }

            uploadedFile = file;
            displayError("");
            uploadPrompt.classList.add("hidden");
            fileFeedback.classList.remove("hidden");
            fileFeedback.innerHTML = `<p class="text-green-400 font-semibold">${file.name} uploaded successfully. Click "Build Bot From Data".</p>`;
            buildBotBtn.disabled = false;
        };

        // --- Parse Excel or CSV data ---
        const parseFileData = () =>
            new Promise((resolve, reject) => {
                if (!uploadedFile) return reject("No file uploaded.");
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        let parsedJson;

                        if (uploadedFile.name.endsWith(".csv")) {
                            const lines = data.split("\n").filter((l) => l.trim() !== "");
                            if (lines.length < 2)
                                throw new Error("CSV file appears to be empty.");
                            const headers = lines[0].split(",").map((h) => h.trim());
                            parsedJson = lines.slice(1).map((line) => {
                                const values = line.split(",");
                                const obj = {};
                                headers.forEach((h, i) => (obj[h] = values[i] || ""));
                                return obj;
                            });
                        } else {
                            const workbook = XLSX.read(data, { type: "binary" });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            parsedJson = XLSX.utils.sheet_to_json(worksheet);
                        }

                        if (!parsedJson || parsedJson.length === 0)
                            throw new Error("File has no readable rows.");

                        jsonData = parsedJson;
                        resolve();
                    } catch (err) {
                        reject("Error reading file: " + err.message);
                    }
                };

                reader.onerror = () => reject("File reading failed.");
                if (uploadedFile.name.endsWith(".csv")) reader.readAsText(uploadedFile);
                else reader.readAsBinaryString(uploadedFile);
            });

        function detectDatasetType(columns) {
            const cols = columns.map(c => c.toLowerCase());
            if (cols.some(c => /brand|model|price/.test(c))) return "laptop";
            if (cols.some(c => /product|item|category|price|quantity/.test(c))) return "supermarket";
            if (cols.some(c => /employee|salary|department|position/.test(c))) return "employee";
            return "generic";
        }


        // --- Smart Rule-Based Data Analysis ---
        function analyzeDataLocally(query) {
            if (!jsonData) return "Please upload a dataset first.";

            const q = query.toLowerCase();
            const columns = Object.keys(jsonData[0]);
            const totalRows = jsonData.length;
            const datasetType = detectDatasetType(columns);

            // Auto-detect key columns
            const brandCol = columns.find(c => /brand/i.test(c));
            const modelCol = columns.find(c => /model|productname/i.test(c));
            const priceCol = columns.find(c => /price/i.test(c));
            const categoryCol = columns.find(c => /category|type/i.test(c));

            // âœ… Summary query
            if (q.includes("summary") || q.includes("overview")) {
                return getGeneralSummary();
            }

            // âœ… Brand-based queries (e.g., "dell", "apple", "hp")
            if (brandCol) {
                const brandValues = [...new Set(jsonData.map(r => String(r[brandCol]).toLowerCase()))];
                const matchedBrand = brandValues.find(b => q.includes(b));

                if (matchedBrand) {
                    const filtered = jsonData.filter(
                        r => String(r[brandCol]).toLowerCase() === matchedBrand
                    );

                    // Detect dataset type (supermarket or laptop)
                    const isSupermarket = Object.keys(jsonData[0]).some(c => /product|category|weight|ml|g/i.test(c));
                    const typeLabel = isSupermarket ? "Products" : "Laptops";

                    let output = `ðŸ›’ **${matchedBrand.toUpperCase()} ${typeLabel} (${filtered.length})**\n\n`;

                    filtered.forEach((r, i) => {
                        const nameValue = r[modelCol] || r.ProductName || r.ItemName || "";
                        const displayName = nameValue.toLowerCase().includes(r[brandCol].toLowerCase())
                            ? nameValue
                            : `${r[brandCol]} ${nameValue}`;

                        const priceValue = r[priceCol] ? `â‚¹${r[priceCol]}` : "Price not available";
                        output += `${i + 1}. ${displayName} â€” ${priceValue}\n`;
                    });

                    return output;
                }
            }


            // âœ… Price: under â‚¹X
            if (priceCol && q.includes("under")) {
                const limit = parseInt(q.match(/under\s+(\d+)/)?.[1]);
                if (limit) {
                    const filtered = jsonData.filter(r => parseFloat(r[priceCol]) <= limit);
                    if (filtered.length === 0) return `âš ï¸ No laptops found under â‚¹${limit}.`;

                    let output = `ðŸ’° **Laptops under â‚¹${limit}:**\n\n`;
                    filtered.forEach((r, i) => {
                        output += `${i + 1}. ${r[brandCol]} ${r[modelCol]} â€” â‚¹${r[priceCol]}\n`;
                    });
                    return output;
                }
            }

            // âœ… Price: under â‚¹X (smart for all datasets)
            if (priceCol && q.includes("under")) {
                const limit = parseInt(q.match(/under\s+(\d+)/)?.[1]);
                if (limit) {
                    const filtered = jsonData.filter(r => parseFloat(r[priceCol]) <= limit);
                    if (filtered.length === 0) return `âš ï¸ No items found under â‚¹${limit}.`;

                    // Detect type (supermarket or laptops)
                    const isSupermarket = Object.keys(jsonData[0]).some(c => /product|item|weight|ml|g/i.test(c));
                    const typeLabel = isSupermarket ? "Products" : "Laptops";

                    let output = `ðŸ’° **${typeLabel} under â‚¹${limit}:**\n\n`;

                    filtered.forEach((r, i) => {
                        const nameValue = r[modelCol] || r.ProductName || r.ItemName || "";
                        const displayName = nameValue.toLowerCase().includes(r[brandCol]?.toLowerCase() || "")
                            ? nameValue
                            : `${r[brandCol]} ${nameValue}`;
                        output += `${i + 1}. ${displayName} â€” â‚¹${r[priceCol]}\n`;
                    });
                    return output;
                }
            }

            // âœ… "How many" queries
            if (q.includes("how many")) {
                if (brandCol) {
                    const brandValues = [...new Set(jsonData.map(r => String(r[brandCol]).toLowerCase()))];
                    const matchedBrand = brandValues.find(b => q.includes(b));

                    if (matchedBrand) {
                        const count = jsonData.filter(
                            r => String(r[brandCol]).toLowerCase() === matchedBrand
                        ).length;
                        return `ðŸ“Š There are **${count} ${matchedBrand.toUpperCase()} laptops** in the dataset.`;
                    }
                }
                return `ðŸ“ The dataset contains **${totalRows} total records.**`;
            }

            // âœ… Model-based queries (e.g., "MacBook Air", "XPS 13")
            if (modelCol) {
                const modelValues = [...new Set(jsonData.map(r => String(r[modelCol]).toLowerCase()))];
                const matchedModel = modelValues.find(m => q.includes(m));

                if (matchedModel) {
                    const item = jsonData.find(
                        r => String(r[modelCol]).toLowerCase() === matchedModel
                    );
                    return `ðŸ’» **${item.Brand} ${item.Model}**\nProcessor: ${item.Processor}\nRAM: ${item.RAM}\nStorage: ${item.Storage}\nPrice: â‚¹${item.Price}`;
                }
            }

            // âœ… Fallback if query doesnâ€™t match
            return `ðŸ¤– Sorry, I couldn't understand your request.\nTry asking things like:\nâ€¢ "Show Dell laptops"\nâ€¢ "Laptops under 60000"\nâ€¢ "How many Apple laptops"\nâ€¢ "MacBook Pro details"`;
        }




        function getGeneralSummary() {
            const columns = Object.keys(jsonData[0]);
            const rowCount = jsonData.length;
            return `### Data Summary\n\nRows: **${rowCount}**\nColumns: **${columns.length}**\n\n**Column Names:**\n${columns
                .map((c) => "â€¢ " + c)
                .join("\n")}\n\nTry asking about any specific column name.`;
        }

        // --- Chat UI ---
        const appendMessage = (sender, text) => {
            const wrapper = document.createElement("div");
            wrapper.className = `flex ${sender === "user" ? "justify-end" : ""}`;
            const bubble = document.createElement("div");
            bubble.className = `chat-bubble p-4 rounded-2xl ${sender === "user" ? "user" : "bot"
                }`;
            bubble.innerHTML =
                sender === "bot" ? marked.parse(text) : `<p>${text}</p>`;
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        // --- Build Bot Button ---
        buildBotBtn.addEventListener("click", async () => {
            btnText.classList.add("hidden");
            btnLoader.classList.remove("hidden");
            buildBotBtn.disabled = true;

            try {
                await parseFileData();
                botName.textContent = uploadedFile.name.replace(/\.[^/.]+$/, "");
                uploadSection.classList.add("hidden");
                chatbotSection.classList.remove("hidden");
                appendMessage(
                    "bot",
                    `âœ… File **${uploadedFile.name}** loaded successfully!\nðŸ’¬ Chatbot is ready to answer your questions.`
                );

            } catch (err) {
                displayError(err);
                btnText.classList.remove("hidden");
                btnLoader.classList.add("hidden");
                buildBotBtn.disabled = false;
            }
        });

        // --- Chat form ---
        chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage("user", query);
            chatInput.value = "";
            thinkingIndicator.classList.remove("hidden");

            try {
                const response = analyzeDataLocally(query);
                thinkingIndicator.classList.add("hidden");
                appendMessage("bot", response);
            } catch {
                thinkingIndicator.classList.add("hidden");
                appendMessage("bot", "âš ï¸ Sorry, I couldnâ€™t process that request.");
            }
        });

        // --- Drag & drop events ---
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eName) => {
            dropZone.addEventListener(eName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        dropZone.addEventListener("dragover", () =>
            dropZone.classList.add("dragover")
        );
        dropZone.addEventListener("dragleave", () =>
            dropZone.classList.remove("dragover")
        );
        dropZone.addEventListener("drop", (e) => {
            dropZone.classList.remove("dragover");
            handleFileSelection(e.dataTransfer.files);
        });

        // --- Utility ---
        const displayError = (msg) => {
            errorMessage.textContent = msg;
            errorMessage.classList.toggle("hidden", !msg);
        };

        function resetApp() {
            uploadedFile = null;
            jsonData = null;
            fileInput.value = "";
            fileFeedback.classList.add("hidden");
            uploadPrompt.classList.remove("hidden");
            buildBotBtn.disabled = true;
            chatbotSection.classList.add("hidden");
            uploadSection.classList.remove("hidden");
            chatWindow.innerHTML = "";
            btnText.classList.remove("hidden");
            btnLoader.classList.add("hidden");
        }
    </script>
</body>

</html>